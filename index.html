<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>カレンダー予約</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
  
  <style>
    body { font-family: sans-serif; padding: 10px; text-align: center; font-size: 14px; }
    #calendar { max-width: 100%; margin: 0 auto; }
    .fc-event { cursor: pointer; border: none; }
    
    /* ステータスごとの色 */
    .status-open { background-color: #06c755 !important; } /* 緑：空き */
    .status-full { background-color: #aaaaaa !important; pointer-events: none; } /* グレー：満席 */
    
    /* 自分の予約の色分け */
    .status-mine-special { background-color: #9b59b6 !important; } /* 紫：特別 */
    .status-mine-makeup  { background-color: #e67e22 !important; } /* オレンジ：振替 */
    .status-mine-default { background-color: #3788d8 !important; } /* 青：その他 */
    
    h2 { margin-bottom: 5px; }

    /* ローディング */
    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      flex-direction: column; z-index: 9999; transition: opacity 0.3s;
    }
    .hidden { opacity: 0; pointer-events: none; }
    .spinner {
      width: 50px; height: 50px;
      border: 5px solid #f3f3f3; border-top: 5px solid #06c755;
      border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #loading-text { color: #555; font-weight: bold; font-size: 14px; }

    /* コース選択モーダル */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 8888;
      display: none; justify-content: center; align-items: center;
    }
    .modal-content {
      background: white; padding: 25px; border-radius: 12px; width: 85%; max-width: 350px; text-align: center;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    }
    .modal-title { font-weight: bold; margin-bottom: 15px; font-size: 16px; }
    .btn-course {
      display: block; width: 100%; padding: 12px; margin-bottom: 10px;
      border: none; border-radius: 8px; font-weight: bold; color: white; cursor: pointer;
      font-size: 15px;
    }
    /* ボタンの色 */
    .btn-special { background: #9b59b6; } /* 紫 */
    .btn-makeup  { background: #e67e22; } /* オレンジ */
    .btn-cancel  { background: #999; margin-top: 5px; }
  </style>
</head>
<body>

  <div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text">システム起動中...</div>
  </div>

  <!-- 2択コース選択ポップアップ -->
  <div id="course-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-title">授業の種類を選んでください</div>
      <button onclick="executeBook('special')" class="btn-course btn-special">特別授業</button>
      <button onclick="executeBook('makeup')" class="btn-course btn-makeup">振替授業</button>
      <button onclick="closeModal()" class="btn-course btn-cancel">やめる</button>
    </div>
  </div>

  <h2>個別指導 カレンダー</h2>
  <div id="calendar"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ★★★ あなたのFirebase設定キーをここに貼り付けてください ★★★
    const firebaseConfig = {
    apiKey: "AIzaSyBp3hvhnBWSvq2TYvsTFmnOnqabnY7vx3g",
    authDomain: "juku-booking.firebaseapp.com",
    projectId: "juku-booking",
    storageBucket: "juku-booking.firebasestorage.app",
    messagingSenderId: "134258298426",
    appId: "1:134258298426:web:24d901ef9fc92c9b0daf03"
  };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ★★★ あなたのLIFF IDをここに貼り付けてください ★★★
    const LIFF_ID = '2008601973-nBb3AdkQ'; 

    let calendar;
    let myUserId = '';
    const CANCEL_LIMIT_MINUTES = 60; // 60分前までキャンセルOK
    let selectedSlotId = ""; 

    // 時差ボケ防止用：日時変換関数
    function parseLocalTime(dateStr, timeStr) {
      if(!dateStr || !timeStr) return new Date();
      const [y, m, d] = dateStr.split('-').map(Number);
      const [hr, min] = timeStr.split(':').map(Number);
      return new Date(y, m - 1, d, hr, min);
    }

    function showLoading(msg) {
      document.getElementById('loading-text').innerText = msg;
      document.getElementById('loading-overlay').classList.remove('hidden');
    }
    function hideLoading() {
      document.getElementById('loading-overlay').classList.add('hidden');
    }

    window.openCourseModal = function(slotId) {
      selectedSlotId = slotId;
      document.getElementById('course-modal').style.display = 'flex';
    }
    window.closeModal = function() {
      document.getElementById('course-modal').style.display = 'none';
    }

    window.onload = function() {
      initCalendar();
      liff.init({ liffId: LIFF_ID }).then(() => {
        if (!liff.isLoggedIn()) {
          liff.login();
        } else {
          liff.getProfile().then(profile => {
            myUserId = profile.userId;
            showLoading("リアルタイム同期中...");
            
            const colRef = collection(db, "bookings");
            onSnapshot(colRef, (snapshot) => {
              const events = snapshot.docs.map(doc => {
                const data = doc.data();
                const slotDate = parseLocalTime(data.date, data.time);
                const now = new Date();
                const isPast = slotDate < now;

                let className = 'status-open';
                let title = data.time;
                let isClickable = true;

                if (data.isBooked) {
                  if (data.userId === myUserId) {
                    // 自分の予約の色分け
                    const type = data.courseType;
                    if(type === 'special') {
                        className = 'status-mine-special';
                        title = '特別';
                    } else if(type === 'makeup') {
                        className = 'status-mine-makeup';
                        title = '振替';
                    } else {
                        className = 'status-mine-default';
                        title = '予約中';
                    }
                  } else {
                    className = 'status-full';
                    title = '満席';
                    isClickable = false; 
                  }
                } else {
                  if (isPast) {
                    className = 'status-full';
                    title = '終了';
                    isClickable = false;
                  }
                }

                return {
                  id: doc.id,
                  title: title,
                  start: `${data.date}T${data.time}`,
                  classNames: [className],
                  extendedProps: {
                    isBooked: data.isBooked,
                    isMine: (data.userId === myUserId),
                    dateStr: data.date, 
                    timeStr: data.time,
                    isClickable: isClickable,
                    courseType: data.courseType
                  }
                };
              });

              calendar.removeAllEvents();
              calendar.addEventSource(events);
              hideLoading();
            });
          });
        }
      });
    };

    function initCalendar() {
      var calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ja',
        height: 'auto',
        headerToolbar: { left: 'prev', center: 'title', right: 'next' },
        eventClick: function(info) {
          const props = info.event.extendedProps;
          if (!props.isClickable && !props.isMine) {
             if (!props.isMine) return;
          }

          const slotDate = parseLocalTime(props.dateStr, props.timeStr);

          if (props.isMine) {
            cancelBooking(info.event.id, slotDate);
          } else if (!props.isBooked) {
            // 過去チェック
            if (slotDate < new Date()) {
                return alert("【エラー】すでに終了している時間です。");
            }
            // OKならポップアップを開く
            openCourseModal(info.event.id);
          }
        }
      });
      calendar.render();
    }

    // 予約実行
    window.executeBook = async function(type) {
      closeModal(); 
      showLoading("予約書き込み中...");
      
      const p = await liff.getProfile();
      const slotRef = doc(db, "bookings", selectedSlotId);
      
      try {
        await updateDoc(slotRef, {
          isBooked: true, 
          userId: p.userId, 
          userName: p.displayName,
          courseType: type 
        });
        alert("予約しました！");
      } catch (e) {
        alert("エラー: " + e.message);
        hideLoading();
      }
    }

    // キャンセル実行
    async function cancelBooking(docId, slotDate) {
      const now = new Date();
      const diffMs = slotDate.getTime() - now.getTime();
      const diffMinutes = diffMs / (1000 * 60);

      // 60分前ルール
      if (diffMinutes < CANCEL_LIMIT_MINUTES) {
        alert(`【キャンセル不可】\n授業開始の ${CANCEL_LIMIT_MINUTES}分前 を過ぎているため、キャンセルできません。\nお電話にてご連絡ください。`);
        return; 
      }

      if(!confirm("キャンセルしますか？")) return;
      showLoading("キャンセル中...");
      
      const slotRef = doc(db, "bookings", docId);
      try {
        await updateDoc(slotRef, {
          isBooked: false, userId: "", userName: "", courseType: "" 
        });
        alert("キャンセルしました");
      } catch (e) {
        alert("エラー: " + e.message);
        hideLoading();
      }
    }
  </script>
</body>
</html>