<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>カレンダー予約 (juku-magic)</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
  
  <style>
    body { font-family: sans-serif; padding: 10px; text-align: center; font-size: 14px; }
    #calendar { max-width: 100%; margin: 0 auto; }
    .fc-event { cursor: pointer; border: none; }
    .status-open { background-color: #06c755 !important; }
    .status-full { background-color: #aaaaaa !important; pointer-events: none; }
    .status-mine { background-color: #3788d8 !important; }
    h2 { margin-bottom: 5px; }
    
    /* ローディング（一瞬で終わるので簡易的に） */
    #loading { color: #666; font-size: 12px; height: 20px; }
  </style>
</head>
<body>

  <h2>特別授業の予約 </h2>
  <div id="loading">システム接続中...</div>
  <div id="calendar"></div>

  <script type="module">
    // 必要な機能をインポート（Googleの倉庫から取ってくる）
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ★★★ さっきメモした「鍵」をここに貼り付けてください！ ★★★
    const firebaseConfig = {
      apiKey: "AIzaSyBp3hvhnBWSvq2TYvsTFmnOnqabnY7vx3g", 
      authDomain: "juku-booking.firebaseapp.com",
      projectId: "juku-booking",
      storageBucket: "juku-booking.firebasestorage.app",
      messagingSenderId: "134258298426",
      appId: "1:134258298426:web:24d901ef9fc92c9b0daf03"
    };
    // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★

    // Firebaseを開始
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // LIFF ID (ここはあなたのものを入れてね！)
    const LIFF_ID = '2008601973-nBb3AdkQ'; 

    let calendar;
    let myUserId = '';

    window.onload = function() {
      initCalendar();
      
      liff.init({ liffId: LIFF_ID })
        .then(() => {
          if (!liff.isLoggedIn()) {
            liff.login();
          } else {
            liff.getProfile().then(profile => {
              myUserId = profile.userId;
              document.getElementById('loading').innerText = "リアルタイム同期中...";
              
              // ★ここが爆速の秘密！「onSnapshot」
              // データベースを見張り続けて、変更があったら瞬時に画面を書き換える
              const colRef = collection(db, "bookings");
              onSnapshot(colRef, (snapshot) => {
                const events = snapshot.docs.map(doc => {
                  const data = doc.data();
                  const startStr = `${data.date}T${data.time}`;
                  
                  let className = 'status-open';
                  let title = data.time;
                  
                  // 判定ロジック
                  if (data.isBooked) {
                    if (data.userId === myUserId) {
                      className = 'status-mine'; // 自分
                      title = '予約中';
                    } else {
                      className = 'status-full'; // 他人
                      title = '満席';
                    }
                  }

                  return {
                    id: doc.id, // ドキュメントID
                    title: title,
                    start: startStr,
                    classNames: [className],
                    extendedProps: {
                      isBooked: data.isBooked,
                      isMine: (data.userId === myUserId)
                    }
                  };
                });

                // カレンダー更新
                calendar.removeAllEvents();
                calendar.addEventSource(events);
                document.getElementById('loading').innerText = "";
              });
            });
          }
        });
    };

    function initCalendar() {
      var calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ja',
        height: 'auto',
        headerToolbar: { left: 'prev', center: 'title', right: 'next' },
        eventClick: function(info) {
          const props = info.event.extendedProps;
          if (props.isMine) {
            cancelBooking(info.event.id, info.event.start);
          } else if (!props.isBooked) {
            book(info.event.id, info.event.start);
          }
        }
      });
      calendar.render();
    }

    // 予約する（書き込み）
    async function book(docId, dateObj) {
      if(!confirm("予約しますか？")) return;
      document.getElementById('loading').innerText = "書き込み中...";
      
      const p = await liff.getProfile();
      
      // Firestoreを直接書き換える
      const slotRef = doc(db, "bookings", docId);
      try {
        await updateDoc(slotRef, {
          isBooked: true,
          userId: p.userId,
          userName: p.displayName
        });
        alert("予約しました！");
      } catch (e) {
        alert("エラー: " + e.message);
      }
    }

    // キャンセルする（書き込み）
    async function cancelBooking(docId, dateObj) {
      if(!confirm("キャンセルしますか？")) return;
      document.getElementById('loading').innerText = "キャンセル中...";
      
      const slotRef = doc(db, "bookings", docId);
      try {
        await updateDoc(slotRef, {
          isBooked: false,
          userId: "",
          userName: ""
        });
        alert("キャンセルしました");
      } catch (e) {
        alert("エラー: " + e.message);
      }
    }
  </script>
</body>
</html>