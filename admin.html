<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã€ç®¡ç†è€…ã€‘äºˆç´„æ è¨­å®š</title>
  
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
  <style>
    body { font-family: sans-serif; padding: 10px; text-align: center; background-color: #f0f0f0; }
    h2 { color: #333; margin-bottom: 5px; }
    #calendar { max-width: 100%; margin: 0 auto; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    
    .fc-event { cursor: pointer; border: none; }
    
    /* ç®¡ç†è€…ç”¨ã®è‰²è¨­å®š */
    .status-empty { background-color: #ffffff; border: 2px dashed #ccc !important; color: #ccc; } /* æœªä½œæˆï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼èƒŒæ™¯ï¼‰ */
    .status-open { background-color: #06c755 !important; } /* ç©ºãæ  */
    .status-booked { background-color: #ff4b4b !important; } /* äºˆç´„æ¸ˆã¿ï¼ˆèµ¤ï¼‰ */
    
    /* ãƒœã‚¿ãƒ³ */
    .btn-create { padding: 10px 20px; background: #333; color: white; border: none; border-radius: 5px; margin-top: 10px; cursor: pointer; }
    
    #loading { color: red; font-weight: bold; height: 20px; font-size: 12px; }
  </style>
</head>
<body>

  <h2>ğŸ‘¨â€ğŸ« äºˆç´„æ  ç®¡ç†ã‚³ãƒƒã‚¯ãƒ”ãƒƒãƒˆ</h2>
  <div id="loading">DBæ¥ç¶šä¸­...</div>
  <div id="calendar"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // â˜…â˜…â˜… ã‚ãªãŸã®éµã‚’è²¼ã£ã¦ãã ã•ã„ â˜…â˜…â˜…
    const firebaseConfig = {
      apiKey: "AIzaSyBp3hvhnBWSvq2TYvsTFmnOnqabnY7vx3g", 
      authDomain: "juku-booking.firebaseapp.com",
      projectId: "juku-booking",
      storageBucket: "juku-booking.firebasestorage.app",
      messagingSenderId: "134258298426",
      appId: "1:134258298426:web:24d901ef9fc92c9b0daf03"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let calendar;

    // ç°¡æ˜“ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ­ãƒƒã‚¯ï¼ˆç”Ÿå¾’ã«è¦‹ã‚‰ã‚Œãªã„ã‚ˆã†ã«ï¼‰
    const PASSWORD = "1234"; // â˜…å¥½ããªæ•°å­—ã«å¤‰ãˆã¦ãã ã•ã„

    window.onload = function() {
      // ç°¡æ˜“ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
      if(prompt("ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„") !== PASSWORD){
        alert("ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒã‚ã‚Šã¾ã›ã‚“");
        document.body.innerHTML = "<h1>Access Denied</h1>";
        return;
      }

      initCalendar();
      
      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ
      const colRef = collection(db, "bookings");
      onSnapshot(colRef, (snapshot) => {
        const events = snapshot.docs.map(doc => {
          const data = doc.data();
          const startStr = `${data.date}T${data.time}`;
          
          let title = data.time;
          let className = 'status-open';
          
          if (data.isBooked) {
            className = 'status-booked'; // äºˆç´„ã‚ã‚Šã¯èµ¤ï¼
            title = `${data.time} ${data.userName}`; // åå‰ã‚’è¡¨ç¤º
          }

          return {
            id: doc.id,
            title: title,
            start: startStr,
            classNames: [className],
            extendedProps: { ...data }
          };
        });

        calendar.removeAllEvents();
        calendar.addEventSource(events);
        document.getElementById('loading').innerText = "";
      });
    };

    function initCalendar() {
      var calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ja',
        height: 'auto',
        headerToolbar: { left: 'prev', center: 'title', right: 'next' },
        
        // â˜…æ—¥ä»˜ã®èƒŒæ™¯ã‚’ã‚¿ãƒƒãƒ—ã—ãŸã‚‰ã€Œæ ä½œæˆã€
        dateClick: function(info) {
          createSlots(info.dateStr);
        },

        // â˜…ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¿ãƒƒãƒ—ã—ãŸã‚‰ã€Œå‰Šé™¤ã€
        eventClick: function(info) {
          deleteSlot(info.event.id, info.event.title);
        }
      });
      calendar.render();
    }

    // æ ã‚’ä¸€æ‹¬ä½œæˆã™ã‚‹æ©Ÿèƒ½
    async function createSlots(dateStr) {
      if(!confirm(`${dateStr} ã«äºˆç´„æ ã‚’ä½œã‚Šã¾ã™ã‹ï¼Ÿ`)) return;
      
      // ä½œã‚ŠãŸã„æ™‚é–“ã‚»ãƒƒãƒˆï¼ˆè‡ªç”±ã«å¢—ã‚„ã›ã¾ã™ï¼‰
      const times = ["17:00", "18:00", "19:00", "20:00"];
      
      document.getElementById('loading').innerText = "æ ã‚’ä½œæˆä¸­...";
      
      // é †ç•ªã«ä¿å­˜ã—ã¦ã„ã
      for (const time of times) {
        try {
          await addDoc(collection(db, "bookings"), {
            date: dateStr,
            time: time,
            isBooked: false,
            userId: "",
            userName: ""
          });
        } catch (e) {
          console.error(e);
        }
      }
      alert("ä½œæˆå®Œäº†ï¼");
      document.getElementById('loading').innerText = "";
    }

    // æ ã‚’å‰Šé™¤ã™ã‚‹æ©Ÿèƒ½
    async function deleteSlot(docId, title) {
      if(!confirm(`ã“ã®æ ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\n${title}`)) return;
      
      try {
        await deleteDoc(doc(db, "bookings", docId));
        alert("å‰Šé™¤ã—ã¾ã—ãŸ");
      } catch (e) {
        alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
      }
    }
  </script>
</body>
</html>