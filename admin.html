<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã€ç®¡ç†è€…ã€‘äºˆç´„æ è¨­å®š</title>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
  <style>
    body { font-family: sans-serif; padding: 10px; text-align: center; background-color: #f0f0f0; }
    h2 { color: #333; margin-bottom: 5px; }
    #calendar { max-width: 100%; margin: 0 auto; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: none; } /* æœ€åˆã¯éš ã™ */
    
    .fc-event { cursor: pointer; border: none; }
    .status-open { background-color: #06c755 !important; }
    .status-booked { background-color: #ff4b4b !important; }
    
    /* ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
    #login-form {
      background: white; padding: 20px; border-radius: 8px; margin-top: 50px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: inline-block;
    }
    input { padding: 10px; margin: 10px 0; width: 200px; display: block; }
    button { padding: 10px 20px; background: #333; color: white; border: none; border-radius: 5px; cursor: pointer; }
    
    #user-display { font-size: 12px; color: #666; margin-bottom: 10px; display: none; }
  </style>
</head>
<body>

  <h2>ğŸ‘¨â€ğŸ« ç®¡ç†è€…ã‚³ãƒƒã‚¯ãƒ”ãƒƒãƒˆ</h2>
  
  <div id="login-form">
    <h3>ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h3>
    <input type="email" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
    <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <button onclick="doLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  </div>

  <div id="user-display"></div>
  <div id="calendar"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    // â˜…èªè¨¼æ©Ÿèƒ½(Auth)ã‚’è¿½åŠ 
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // â˜…â˜…â˜… ã‚ãªãŸã®éµã‚’è²¼ã£ã¦ãã ã•ã„ â˜…â˜…â˜…
    const firebaseConfig = {
      apiKey: "AIzaSyBp3hvhnBWSvq2TYvsTFmnOnqabnY7vx3g", 
      authDomain: "juku-booking.firebaseapp.com",
      projectId: "juku-booking",
      storageBucket: "juku-booking.firebasestorage.app",
      messagingSenderId: "134258298426",
      appId: "1:134258298426:web:24d901ef9fc92c9b0daf03"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app); // èªè¨¼æ©Ÿèƒ½ON

    let calendar;

    // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç›£è¦–ï¼ˆãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸæ™‚ã«è‡ªå‹•ãƒã‚§ãƒƒã‚¯ï¼‰
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('calendar').style.display = 'block';
        document.getElementById('user-display').style.display = 'block';
        document.getElementById('user-display').innerText = "Login: " + user.email;
        
        initCalendar();
        loadData();
      } else {
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹
        document.getElementById('login-form').style.display = 'block';
        document.getElementById('calendar').style.display = 'none';
      }
    });

    // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ã
    window.doLogin = function() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      
      signInWithEmailAndPassword(auth, email, pass)
        .then((userCredential) => {
          // æˆåŠŸã—ãŸã‚‰ onAuthStateChanged ãŒå‹•ãã®ã§ä½•ã‚‚ã—ãªãã¦OK
        })
        .catch((error) => {
          alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + error.message);
        });
    }

    function loadData() {
      const colRef = collection(db, "bookings");
      onSnapshot(colRef, (snapshot) => {
        const events = snapshot.docs.map(doc => {
          const data = doc.data();
          let title = data.time;
          let className = 'status-open';
          if (data.isBooked) {
            className = 'status-booked';
            title = `${data.time} ${data.userName}`;
          }
          return {
            id: doc.id,
            title: title,
            start: `${data.date}T${data.time}`,
            classNames: [className],
            extendedProps: { ...data }
          };
        });
        calendar.removeAllEvents();
        calendar.addEventSource(events);
      });
    }

    function initCalendar() {
      if(calendar) return; // äºŒé‡èµ·å‹•é˜²æ­¢
      var calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ja',
        height: 'auto',
        headerToolbar: { left: 'prev', center: 'title', right: 'next' },
        dateClick: function(info) { createSlots(info.dateStr); },
        eventClick: function(info) { deleteSlot(info.event.id, info.event.title); }
      });
      calendar.render();
    }

    async function createSlots(dateStr) {
      if(!confirm(`${dateStr} ã«äºˆç´„æ ã‚’ä½œã‚Šã¾ã™ã‹ï¼Ÿ`)) return;
      const times = ["17:00", "18:00", "19:00", "20:00"];
      for (const time of times) {
        await addDoc(collection(db, "bookings"), {
          date: dateStr, time: time, isBooked: false, userId: "", userName: ""
        });
      }
      alert("ä½œæˆå®Œäº†");
    }

    async function deleteSlot(docId, title) {
      if(!confirm(`å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n${title}`)) return;
      await deleteDoc(doc(db, "bookings", docId));
      alert("å‰Šé™¤ã—ã¾ã—ãŸ");
    }
  </script>
</body>
</html>