<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã€ç®¡ç†è€…ã€‘äºˆç´„æ è¨­å®š</title>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
  <style>
    body { font-family: sans-serif; padding: 10px; text-align: center; background-color: #f0f0f0; }
    h2 { color: #333; margin-bottom: 5px; }
    #calendar { max-width: 100%; margin: 0 auto; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: none; }
    
    .fc-event { cursor: pointer; border: none; }
    .status-open { background-color: #06c755 !important; }
    .status-booked { background-color: #ff4b4b !important; }
    
    #login-form {
      background: white; padding: 20px; border-radius: 8px; margin-top: 50px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: inline-block;
    }
    input { padding: 10px; margin: 10px 0; width: 200px; display: block; }
    button { padding: 10px 20px; background: #333; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .btn-logout { background: #666 !important; font-size: 12px; margin-left: 10px; }
    
    #dashboard-header { margin-bottom: 20px; display: none; }
    #user-display { font-size: 14px; color: #333; font-weight: bold; }

    /* ãƒ‘ãƒãƒ«å…±é€šãƒ‡ã‚¶ã‚¤ãƒ³ */
    .panel-box {
      background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;
      border: 2px solid #333; display: none; text-align: left;
    }
    .panel-box h3 { margin-top: 0; border-bottom: 1px solid #ddd; padding-bottom: 5px;}
    .form-group { margin-bottom: 10px; }
    .form-group label { display: block; font-weight: bold; margin-bottom: 5px; }
    /* æ™‚é–“ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å°‘ã—å°ã•ãä¸¦ã¹ã‚‹ */
    .checkbox-group { display: flex; flex-wrap: wrap; gap: 5px; }
    .checkbox-group label { 
        display: inline-block; font-weight: normal; background: #eee; padding: 5px 8px; border-radius: 4px; font-size: 12px;
    }
    
    .btn-toggle { width: 100%; margin-bottom: 10px; font-size: 14px; padding: 8px; }
    .btn-create { background: #0096FF !important; color: white; }
    .btn-delete { background: #FF4B4B !important; color: white; }
    
    .btn-exec-create { background: #0096FF !important; width: 100%; font-weight: bold; margin-top: 10px; }
    .btn-exec-delete { background: #FF4B4B !important; width: 100%; font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>

  <h2>ğŸ‘¨â€ğŸ« ç®¡ç†è€…ã‚³ãƒƒã‚¯ãƒ”ãƒƒãƒˆ</h2>
  
  <div id="login-form">
    <h3>ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h3>
    <input type="email" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
    <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <button onclick="doLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  </div>

  <div id="dashboard-header">
    <span id="user-display"></span>
    <button onclick="doLogout()" class="btn-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    <br><br>
    <div style="display:flex; gap:10px;">
      <button onclick="togglePanel('create')" class="btn-toggle btn-create">âš¡ï¸ ä¸€æ‹¬ä½œæˆãƒ„ãƒ¼ãƒ«</button>
      <button onclick="togglePanel('delete')" class="btn-toggle btn-delete">ğŸ—‘ï¸ ä¸€æ‹¬å‰Šé™¤ãƒ„ãƒ¼ãƒ«</button>
    </div>
  </div>

  <div id="panel-create" class="panel-box">
    <h3>âš¡ï¸ ã‚·ãƒ•ãƒˆä¸€æ‹¬ä½œæˆ</h3>
    <div class="form-group">
      <label>1. å¯¾è±¡ã®æœˆ</label>
      <input type="month" id="create-month">
    </div>
    <div class="form-group">
      <label>2. æ›œæ—¥</label>
      <div class="checkbox-group">
        <label><input type="checkbox" name="create-dow" value="1">æœˆ</label>
        <label><input type="checkbox" name="create-dow" value="2">ç«</label>
        <label><input type="checkbox" name="create-dow" value="3">æ°´</label>
        <label><input type="checkbox" name="create-dow" value="4">æœ¨</label>
        <label><input type="checkbox" name="create-dow" value="5">é‡‘</label>
        <label><input type="checkbox" name="create-dow" value="6">åœŸ</label>
        <label><input type="checkbox" name="create-dow" value="0">æ—¥</label>
      </div>
    </div>
    <div class="form-group">
      <label>3. æ™‚é–“</label>
      <div class="checkbox-group">
        <label><input type="checkbox" name="create-time" value="10:00">10:00</label>
        <label><input type="checkbox" name="create-time" value="11:00">11:00</label>
        <label><input type="checkbox" name="create-time" value="12:00">12:00</label>
        <label><input type="checkbox" name="create-time" value="13:00">13:00</label>
        <label><input type="checkbox" name="create-time" value="14:00">14:00</label>
        <label><input type="checkbox" name="create-time" value="15:00">15:00</label>
        <label><input type="checkbox" name="create-time" value="16:00">16:00</label>
        <label><input type="checkbox" name="create-time" value="17:00" checked>17:00</label>
        <label><input type="checkbox" name="create-time" value="18:00" checked>18:00</label>
        <label><input type="checkbox" name="create-time" value="19:00" checked>19:00</label>
        <label><input type="checkbox" name="create-time" value="20:00">20:00</label>
        <label><input type="checkbox" name="create-time" value="21:00">21:00</label>
        <label><input type="checkbox" name="create-time" value="22:00">22:00</label>
      </div>
    </div>
    <button onclick="executeBulkCreate()" class="btn-exec-create">ä¸€æ‹¬ä½œæˆã™ã‚‹ï¼</button>
  </div>

  <div id="panel-delete" class="panel-box">
    <h3>ğŸ—‘ï¸ ã‚·ãƒ•ãƒˆä¸€æ‹¬å‰Šé™¤</h3>
    <p style="font-size:12px; color:red;">â€»äºˆç´„ãŒå…¥ã£ã¦ã„ã‚‹æ ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚</p>
    
    <div class="form-group">
      <label>1. å¯¾è±¡ã®æœˆ</label>
      <input type="month" id="delete-month">
    </div>
    <div class="form-group">
      <label>2. æ›œæ—¥</label>
      <div class="checkbox-group">
        <label><input type="checkbox" name="delete-dow" value="1">æœˆ</label>
        <label><input type="checkbox" name="delete-dow" value="2">ç«</label>
        <label><input type="checkbox" name="delete-dow" value="3">æ°´</label>
        <label><input type="checkbox" name="delete-dow" value="4">æœ¨</label>
        <label><input type="checkbox" name="delete-dow" value="5">é‡‘</label>
        <label><input type="checkbox" name="delete-dow" value="6">åœŸ</label>
        <label><input type="checkbox" name="delete-dow" value="0">æ—¥</label>
      </div>
    </div>
    <div class="form-group">
      <label>3. æ™‚é–“</label>
      <div class="checkbox-group">
        <label><input type="checkbox" name="delete-time" value="10:00">10:00</label>
        <label><input type="checkbox" name="delete-time" value="11:00">11:00</label>
        <label><input type="checkbox" name="delete-time" value="12:00">12:00</label>
        <label><input type="checkbox" name="delete-time" value="13:00">13:00</label>
        <label><input type="checkbox" name="delete-time" value="14:00">14:00</label>
        <label><input type="checkbox" name="delete-time" value="15:00">15:00</label>
        <label><input type="checkbox" name="delete-time" value="16:00">16:00</label>
        <label><input type="checkbox" name="delete-time" value="17:00">17:00</label>
        <label><input type="checkbox" name="delete-time" value="18:00">18:00</label>
        <label><input type="checkbox" name="delete-time" value="19:00">19:00</label>
        <label><input type="checkbox" name="delete-time" value="20:00">20:00</label>
        <label><input type="checkbox" name="delete-time" value="21:00">21:00</label>
        <label><input type="checkbox" name="delete-time" value="22:00">22:00</label>
      </div>
    </div>
    <button onclick="executeBulkDelete()" class="btn-exec-delete">ä¸€æ‹¬å‰Šé™¤ã™ã‚‹ï¼</button>
  </div>

  <div id="calendar"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, writeBatch, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // â˜…â˜…â˜… éµã‚’ã“ã“ã«è²¼ã‚Šç›´ã—ã¦ãã ã•ã„ï¼ â˜…â˜…â˜…
    const firebaseConfig = {
    apiKey: "AIzaSyBp3hvhnBWSvq2TYvsTFmnOnqabnY7vx3g",
    authDomain: "juku-booking.firebaseapp.com",
    projectId: "juku-booking",
    storageBucket: "juku-booking.firebasestorage.app",
    messagingSenderId: "134258298426",
    appId: "1:134258298426:web:24d901ef9fc92c9b0daf03"
  };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app); 

    let calendar;

    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('calendar').style.display = 'block';
        document.getElementById('dashboard-header').style.display = 'block';
        document.getElementById('user-display').innerText = "Login: " + user.email;
        initCalendar();
        loadData();
      } else {
        document.getElementById('login-form').style.display = 'block';
        document.getElementById('calendar').style.display = 'none';
        document.getElementById('dashboard-header').style.display = 'none';
        document.getElementById('panel-create').style.display = 'none';
        document.getElementById('panel-delete').style.display = 'none';
      }
    });

    window.doLogin = function() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      signInWithEmailAndPassword(auth, email, pass).catch(e => alert("Error: " + e.message));
    }

    window.doLogout = function() {
      if(confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) signOut(auth);
    }

    window.togglePanel = function(type) {
      const createPanel = document.getElementById('panel-create');
      const deletePanel = document.getElementById('panel-delete');
      if (type === 'create') {
        createPanel.style.display = (createPanel.style.display === 'none') ? 'block' : 'none';
        deletePanel.style.display = 'none';
      } else {
        deletePanel.style.display = (deletePanel.style.display === 'none') ? 'block' : 'none';
        createPanel.style.display = 'none';
      }
    }

    window.executeBulkCreate = async function() {
      const monthVal = document.getElementById('create-month').value;
      if (!monthVal) return alert("æœˆã‚’é¸æŠã—ã¦ãã ã•ã„");
      const dowChecks = document.querySelectorAll('input[name="create-dow"]:checked');
      const targetDows = Array.from(dowChecks).map(c => parseInt(c.value));
      if (targetDows.length === 0) return alert("æ›œæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„");
      const timeChecks = document.querySelectorAll('input[name="create-time"]:checked');
      const targetTimes = Array.from(timeChecks).map(c => c.value);
      if (targetTimes.length === 0) return alert("æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„");

      if (!confirm(`${monthVal} ã®æŒ‡å®šã—ãŸæ—¥æ™‚ã«ã€äºˆç´„æ ã‚’ä¸€æ‹¬ä½œæˆã—ã¾ã™ã‹ï¼Ÿ`)) return;

      const [year, month] = monthVal.split('-').map(Number);
      const startDate = new Date(year, month - 1, 1);
      const endDate = new Date(year, month, 0);
      
      const batch = writeBatch(db);
      let count = 0;

      for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        if (targetDows.includes(d.getDay())) {
          const y = d.getFullYear();
          const m = ('0' + (d.getMonth() + 1)).slice(-2);
          const day = ('0' + d.getDate()).slice(-2);
          const dateStr = `${y}-${m}-${day}`;

          targetTimes.forEach(time => {
            const newRef = doc(collection(db, "bookings"));
            batch.set(newRef, { date: dateStr, time: time, isBooked: false, userId: "", userName: "" });
            count++;
          });
        }
      }

      if (count === 0) return alert("å¯¾è±¡æ—¥ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
      if (count > 500) return alert("ä»¶æ•°ãŒå¤šã™ãã¾ã™(500ä»¶è¶…)");

      try {
        await batch.commit();
        alert(`æˆåŠŸï¼ ${count}ä»¶ä½œæˆã—ã¾ã—ãŸ`);
        document.getElementById('panel-create').style.display = 'none';
      } catch (e) {
        alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
      }
    }

    window.executeBulkDelete = async function() {
      const monthVal = document.getElementById('delete-month').value;
      if (!monthVal) return alert("æœˆã‚’é¸æŠã—ã¦ãã ã•ã„");
      const dowChecks = document.querySelectorAll('input[name="delete-dow"]:checked');
      const targetDows = Array.from(dowChecks).map(c => parseInt(c.value));
      if (targetDows.length === 0) return alert("æ›œæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„");
      const timeChecks = document.querySelectorAll('input[name="delete-time"]:checked');
      const targetTimes = Array.from(timeChecks).map(c => c.value);
      if (targetTimes.length === 0) return alert("æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„");

      if (!confirm(`ã€æ³¨æ„ã€‘\n${monthVal} ã®æŒ‡å®šæ ã‚’ä¸€æ‹¬å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆäºˆç´„æ¸ˆã¿ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰`)) return;

      const [year, month] = monthVal.split('-').map(Number);
      const startStr = `${year}-${('0'+month).slice(-2)}-01`;
      const lastDay = new Date(year, month, 0).getDate();
      const endStr = `${year}-${('0'+month).slice(-2)}-${lastDay}`;

      const q = query(collection(db, "bookings"), 
        where("date", ">=", startStr),
        where("date", "<=", endStr)
      );

      try {
        const querySnapshot = await getDocs(q);
        const batch = writeBatch(db);
        let deleteCount = 0;
        let skippedCount = 0;

        querySnapshot.forEach((doc) => {
          const data = doc.data();
          const dateObj = new Date(data.date);
          if (targetDows.includes(dateObj.getDay()) && targetTimes.includes(data.time)) {
            if (data.isBooked) {
              skippedCount++;
            } else {
              batch.delete(doc.ref);
              deleteCount++;
            }
          }
        });

        if (deleteCount === 0) return alert("å‰Šé™¤å¯¾è±¡ãªã—");
        await batch.commit();
        alert(`å®Œäº†ï¼\nå‰Šé™¤: ${deleteCount}ä»¶\nã‚¹ã‚­ãƒƒãƒ—: ${skippedCount}ä»¶`);
        document.getElementById('panel-delete').style.display = 'none';
      } catch (e) {
        alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
      }
    }

    function loadData() {
      const colRef = collection(db, "bookings");
      onSnapshot(colRef, (snapshot) => {
        const events = snapshot.docs.map(doc => {
          const data = doc.data();
          let title = data.time;
          let className = 'status-open';
          if (data.isBooked) {
            className = 'status-booked';
            title = `${data.time} ${data.userName}`;
          }
          return {
            id: doc.id,
            title: title,
            start: `${data.date}T${data.time}`,
            classNames: [className],
            extendedProps: { ...data }
          };
        });
        calendar.removeAllEvents();
        calendar.addEventSource(events);
      });
    }

    function initCalendar() {
      if(calendar) return; 
      var calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ja',
        height: 'auto',
        headerToolbar: { left: 'prev', center: 'title', right: 'next' },
        
        // â˜…æ—¥ä»˜ã‚¿ãƒƒãƒ—ä½œæˆæ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ™‚é–“ã‚’10:00-22:00ã®å…¨æ ã«å¤‰æ›´
        dateClick: function(info) { createSlots(info.dateStr); },
        eventClick: function(info) { deleteSlot(info.event.id, info.event.title); }
      });
      calendar.render();
    }

    async function createSlots(dateStr) {
      if(!confirm(`${dateStr} ã«\n10:00ã€œ22:00 ã®äºˆç´„æ ã‚’ä¸€æ‹¬ä½œæˆã—ã¾ã™ã‹ï¼Ÿ`)) return;
      
      // â˜…ã“ã“ã‚‚10:00ã€œ22:00ã«å¤‰æ›´ã—ã¾ã—ãŸï¼
      const times = [
        "10:00", "11:00", "12:00", "13:00", "14:00", "15:00",
        "16:00", "17:00", "18:00", "19:00", "20:00", "21:00", "22:00"
      ];
      
      for (const time of times) {
        await addDoc(collection(db, "bookings"), {
          date: dateStr, time: time, isBooked: false, userId: "", userName: ""
        });
      }
      alert("ä½œæˆå®Œäº†");
    }

    async function deleteSlot(docId, title) {
      if(!confirm(`å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n${title}`)) return;
      await deleteDoc(doc(db, "bookings", docId));
      alert("å‰Šé™¤ã—ã¾ã—ãŸ");
    }
  </script>
</body>
</html>